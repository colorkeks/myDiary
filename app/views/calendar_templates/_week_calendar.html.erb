<div class="diary week_calendar">
  <div class="calendar-head">
    <div class="left-panel">
      <%= link_to t('diary.previous', default: 'Пред.'), calendar.prev_page, class: 'btn btn-default' %>
      <%= link_to t('diary.next', default: 'След.'), calendar.next_page, class: 'btn btn-default' %>
      <%= link_to t('diary.today', default: 'Сегодня'), calendar.today, class: 'btn btn-default' %>
    </div>
    <span class="date-title"><%= start_date.strftime('%B %Y') %></span>
    <div class="right-panel">
      <div class="btn-group">
        <%= link_to t('diary.today', default: 'День'), calendar.to_calendar('day_calendar'), class: 'btn btn-default' %>
        <%= link_to t('diary.today', default: 'Неделя'), calendar.to_calendar('week_calendar'), class: 'btn btn-default' %>
        <%= link_to t('diary.today', default: 'Месяц'), calendar.to_calendar('month_calendar'), class: 'btn btn-default' %>
      </div>
    </div>
  </div>

  <table class="table week_table">
    <thead>
    <tr class="table-header">
      <td class="hours">Hours</td>
      <% date_range.slice(0, 7).each do |day| %>
          <%= content_tag :td, class: calendar.td_classes_for(day) do %>
              <%= day.strftime('%A %d') %>
          <% end %>
      <% end %>
    </tr>
    </thead>
  </table>


  <table class="table week_table">
    <tbody>
    <tr>
      <td style="border: none">
        <div style="position: relative">
          <div style="position: relative;width: 100%;">
            <div class="week-event-content">
              <table class="table week_table">
                <tbody>
                <tr>
                  <td class="hours"></td>
                  <% date_range.slice(0, 7).each do |day| %>
                      <%= content_tag :td, class: calendar.td_classes_for(day) do %>
                      <% end %>
                  <% end %>
                </tr>
                </tbody>
              </table>
            </div>

            <div class="all_day_row">
              <table class="all_day_table">
                <tr>
                  <td class="hours">AllDay</td>
                  <td>
                    <div class="all_day_scrollable">
                      <table>
                        <tbody class="all_day_content">
                        <!-- TODO DRAG AND DROP (нужно больше боли !) -->
                        <!-- TODO ADD RESIZABLE-->
                        <!-- TODO ЕСЛИ НЕ ALLDAY ТО РЕСАЙЗИТЬ НЕЛЬЗЯ-->
                        <!-- TODO ПРИДУМАТЬ КУДА ДЕТЬ ЭТОТ КОД (ТАКОЙ-ЖЕ В MONTH_CALENDAR) МБ ЗАПИХАТЬ В КАКОЙ_НИТЬ ХЭЛПЕР ИЛИ ПРОСТО PARTIAL-->
                        <% (sorted_events.select { |key| !(key.to_a & date_range.to_a).empty? }).each do |pair| %>
                            <% key = pair.fetch(0) %>

                            <% pair.fetch(1).each do |event| %>
                                <% start_date = event.start_date.to_date %>
                                <% end_date = event.end_date.to_date %>
                                <% start_included = date_range.include?(start_date) %>
                                <% end_included = date_range.include?(end_date) %>
                                <% start_date_wday = (start_date.wday + 6) % 7 %>
                                <% end_date_wday = 1 + (end_date.wday + 6) % 7 %>
                                <tr>
                                  <% if date_range.to_a.include?(start_date) %>
                                      <% (start_date_wday).times do %>
                                          <td></td>
                                      <% end %>
                                  <% end %>

                                  <!--Если начало и конец на одной неделе-->
                                  <% if start_included && end_included %>
                                      <td class="event" colspan="<%= end_date_wday - start_date_wday %>">
                                        <!--Для длительных событый которые занимают всю неделю+ -->
                                  <% elsif key.include?(date_range.first) && key.include?(date_range.last) %>
                                      <td class="event" colspan="7">
                                        <!--Если только начало на этой неделе-->
                                  <% elsif start_included %>
                                      <% max = 7 - start_date_wday %>
                                      <% current = (end_date - start_date).to_i %>
                                      <td class="event" colspan="<%= current > max ? max : current %>">
                                        <!--Если только конец на этой неделе-->
                                  <% elsif end_included %>
                                      <td class="event" colspan="<%= end_date_wday %>">
                                  <% end %>
                                  <%= event.title %>
                                  </td>
                                </tr>
                            <% end %>
                        <% end %>
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
              </table>
            </div>

            <div class="scrollable">
              <div style="position: relative">

                <div style="position: relative">
                  <table class="week_table_row">
                    <% (0 .. 84600).step(1800) do |hour| %>
                        <% time = Time.at(hour).utc %>
                        <tr data-time="<%= time.strftime('%H:%M') %>">
                          <td class="hours" style="z-index: 100"><%= time.strftime('%H:%M') %></td>
                          <td colspan="7"></td>
                        </tr>
                    <% end %>
                  </table>
                </div>

                <div class="week-event-content">
                  <table class="table event_week_table">
                    <tbody>
                    <tr>
                      <td class="hours"></td>
                      <% date_range.slice(0, 7).each do |day| %>
                          <% if (sorted_events.select { |key| key === day }).empty? %>
                              <td></td>
                          <% else %>
                              <td>
                                <div style="position: relative">
                                  <!--TODO СДЕЛАТЬ РАСЧЕТЫ ЧТОБЫ ABSOLUTE EVENTS НЕ НАСЛАИВАЛИСЬ ДРУГ НА ДРУГА( ПОКА БЕЗ ПОНЯТИЯ КАК ЭТО СДЕЛАТь)-->
                                  <!-- TODO ADD RESIZABLE-->
                                  <!-- TODO DRAG AND DROP (нужно больше боли !) -->
                                  <% (sorted_events.select { |key| key === start_date }).each do |pair| %>
                                      <% pair.fetch(1).each_with_index do |event, index| %>
                                          <% next if event.all_day %>

                                          <% position = index.odd? ? 'right: ' + index.to_s + 'px' : 'left: ' + index.to_s + 'px' %>
                                          <% width = (115/sorted_events.count).to_s + 'px' %>
                                          <% top_position = (event.start_date.hour + (event.start_date.strftime('%M').to_i)/60.0)*220-15 %>

                                          <% if event.end_date.day - event.start_date.day == 0 %>
                                              <% event_height = ((event.end_date.hour - event.start_date.hour) +
                                                  (event.end_date.strftime('%M').to_i - event.start_date.strftime('%M').to_i)/60.0)*220 %>
                                          <% else %>
                                              <% event_height = (24 -(event.start_date.hour + (event.start_date.strftime('%M').to_i)/60.0))*220 %>
                                          <% end %>

                                          <div style="position: relative; display: inline-block">
                                            <div class="event" style="position: absolute; height: <%= event_height %>px; top:<%= top_position %>px; <%= position %>; width: <%= width %> ">
                                              <%= event.title %>
                                            </div>
                                          </div>
                                      <% end %>
                                  <% end %>
                                </div>
                              </td>
                          <% end %>
                      <% end %>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </td>

    </tr>
    </tbody>
  </table>

</div>


